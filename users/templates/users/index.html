{% extends 'users/base.html' %}

{% block content %}
<div id="app" class="min-h-screen flex flex-col relative">

    {% include 'users/components/header.html' %}

    <!-- Main Content Area -->
    <main class="flex-1 flex flex-col">

        {% include 'users/components/auth.html' %}

        <!-- PAGE 2: Main Dashboard -->
        <div v-else-if="currentStep === 'main'" key="main" class="max-w-5xl mx-auto px-4 sm:px-6 py-8 w-full">

            {% include 'users/components/home_tab.html' %}
            {% include 'users/components/sale_tab.html' %}
            {% include 'users/components/community_tab.html' %}

        </div>

        {% include 'users/components/profile_tab.html' %}
    </main>

    {% include 'users/components/mobile_nav.html' %}

</div>
{% endblock %}

{% block scripts %}
<script>
    const { createApp, ref, computed, onMounted, reactive } = Vue;

    // --- MOCK DATA (Normally from DB) ---
    const rawSaleData = [
        { "game_id": "app1086940", "title": "Baldur's Gate 3", "current_price": 49500, "original_price": 66000, "discount_rate": 0.25, "thumbnail": "https://shared.akamai.steamstatic.com/store_item_assets/steam/apps/1086940/3dd81008e9c385caf68152450c22353f6a8abec9/capsule_231x87.jpg", "store_link": "https://store.steampowered.com/app/1086940/Baldurs_Gate_3/" },
        { "game_id": "app1245620", "title": "Elden Ring", "current_price": 44800, "original_price": 64800, "discount_rate": 0.3, "thumbnail": "https://shared.akamai.steamstatic.com/store_item_assets/steam/apps/1245620/capsule_231x87.jpg", "store_link": "https://store.steampowered.com/app/1245620/Elden_Ring/" },
        { "game_id": "app2679460", "title": "Metaphor: ReFantazio", "current_price": 39900, "original_price": 79800, "discount_rate": 0.5, "thumbnail": "https://shared.akamai.steamstatic.com/store_item_assets/steam/apps/2679460/capsule_231x87.jpg", "store_link": "https://store.steampowered.com/app/2679460/Metaphor_ReFantazio/" },
        { "game_id": "app1904540", "title": "Football Manager 2023", "current_price": 23600, "original_price": 59000, "discount_rate": 0.6, "thumbnail": "https://cdn.cloudflare.steamstatic.com/steam/apps/1904540/capsule_sm_120.jpg", "store_link": "https://store.steampowered.com/app/1904540/Football_Manager_2023/" },
        { "game_id": "app524220", "title": "NieR:Automata™", "current_price": 15680, "original_price": 44800, "discount_rate": 0.65, "thumbnail": "https://shared.akamai.steamstatic.com/store_item_assets/steam/apps/524220/capsule_231x87.jpg", "store_link": "https://store.steampowered.com/app/524220/NieRAutomata/" },
        { "game_id": "app1332010", "title": "Stray", "current_price": 21000, "original_price": 35000, "discount_rate": 0.4, "thumbnail": "https://shared.akamai.steamstatic.com/store_item_assets/steam/apps/1332010/capsule_231x87.jpg", "store_link": "https://store.steampowered.com/app/1332010/Stray/" },
        { "game_id": "app2369390", "title": "Far Cry® 6", "current_price": 13000, "original_price": 65000, "discount_rate": 0.8, "thumbnail": "https://shared.akamai.steamstatic.com/store_item_assets/steam/apps/2369390/capsule_231x87.jpg", "store_link": "https://store.steampowered.com/app/2369390/Far_Cry_6/" },
        { "game_id": "app2561580", "title": "Horizon Zero Dawn™ Remastered", "current_price": 35280, "original_price": 58800, "discount_rate": 0.4, "thumbnail": "https://shared.akamai.steamstatic.com/store_item_assets/steam/apps/2561580/507f27b6be81658f406a42e269a2e4b065941ade/capsule_231x87.jpg", "store_link": "https://store.steampowered.com/app/2561580/Horizon_Zero_Dawn_Remastered/" },
        { "game_id": "app1222730", "title": "STAR WARS™: Squadrons", "current_price": 2200, "original_price": 44000, "discount_rate": 0.95, "thumbnail": "https://shared.akamai.steamstatic.com/store_item_assets/steam/apps/1222730/capsule_231x87.jpg", "store_link": "https://store.steampowered.com/app/1222730/STAR_WARS_Squadrons/" },
        { "game_id": "app1605220", "title": "Dune: Spice Wars", "current_price": 15120, "original_price": 30500, "discount_rate": 0.6, "thumbnail": "https://shared.akamai.steamstatic.com/store_item_assets/steam/apps/1605220/capsule_231x87.jpg", "store_link": "https://store.steampowered.com/app/1605220/Dune_Spice_Wars/" },
        { "game_id": "app383870", "title": "Firewatch", "current_price": 2150, "original_price": 21000, "discount_rate": 0.9, "thumbnail": "https://shared.akamai.steamstatic.com/store_item_assets/steam/apps/383870/4bede1250e3ec63295fa3f019311d4a30a1a4bce/capsule_231x87.jpg", "store_link": "https://store.steampowered.com/app/383870/Firewatch/" },
        { "game_id": "app1196090", "title": "Scars Above", "current_price": 3040, "original_price": 30400, "discount_rate": 0.9, "thumbnail": "https://shared.akamai.steamstatic.com/store_item_assets/steam/apps/1196090/capsule_231x87.jpg", "store_link": "https://store.steampowered.com/app/1196090/Scars_Above/" },
        { "game_id": "app2058180", "title": "Judgment", "current_price": 10440, "original_price": 34800, "discount_rate": 0.7, "thumbnail": "https://shared.akamai.steamstatic.com/store_item_assets/steam/apps/2058180/capsule_231x87.jpg", "store_link": "https://store.steampowered.com/app/2058180/Judgment/" },
        { "game_id": "app863550", "title": "HITMAN™ 2", "current_price": 24800, "original_price": 62000, "discount_rate": 0.6, "thumbnail": "https://cdn.cloudflare.steamstatic.com/steam/apps/863550/capsule_sm_120.jpg", "store_link": "https://store.steampowered.com/app/863550/HITMAN_2/" },
        { "game_id": "app448510", "title": "Overcooked", "current_price": 3600, "original_price": 18000, "discount_rate": 0.8, "thumbnail": "https://shared.akamai.steamstatic.com/store_item_assets/steam/apps/448510/capsule_231x87.jpg", "store_link": "https://store.steampowered.com/app/448510/Overcooked/" },
        { "game_id": "app924150", "title": "Farm Together", "current_price": 4400, "original_price": 11000, "discount_rate": 0.6, "thumbnail": "https://shared.akamai.steamstatic.com/store_item_assets/steam/apps/924150/capsule_231x87.jpg", "store_link": "https://store.steampowered.com/app/924150/" },
        { "game_id": "app304390", "title": "FOR HONOR™", "current_price": 4950, "original_price": 16500, "discount_rate": 0.7, "thumbnail": "https://shared.akamai.steamstatic.com/store_item_assets/steam/apps/304390/5b4909717c94e99511e459aad48cd2202e191046/capsule_231x87.jpg", "store_link": "https://store.steampowered.com/app/304390/FOR_HONOR/" },
        { "game_id": "app2815270", "title": "The Sims™ 4 Lovestruck", "current_price": 22000, "original_price": 44000, "discount_rate": 0.5, "thumbnail": "https://shared.akamai.steamstatic.com/store_item_assets/steam/apps/2815270/capsule_231x87.jpg", "store_link": "https://store.steampowered.com/app/2815270/" }
    ];

    createApp({
        setup() {
            // State
            const currentStep = ref('main'); // Forced main view for logged-in users
            const currentTab = ref('home'); // 'home', 'sale'
            const isLoginMode = ref(true); // Toggle between Login and Signup
            const user = ref({ nickname: '{{ user.nickname }}', email: '{{ user.email }}' }); // Inject Django user data
            const games = ref([]);
            const wishlist = ref([]);

            // Community State
            const communityPosts = ref([]);
            const isWritingPost = ref(false);
            const communityCategory = ref('all');
            const selectedPost = ref(null);
            const fileInput = ref(null);
            const newPost = reactive({ title: '', content: '', category: 'free', file: null });

            // Auth Form State
            const authForm = reactive({
                email: '',
                password: '',
                nickname: ''
            });

            // Sorting State
            const sortBy = ref('interest');

            onMounted(async () => {
                // Initialize Game Data from Django
                // Use verbatim block or different delimiters if mixing Vue and Django extensively
                // Here we initialize from rawSaleData for demo purposes, but ideally this comes from views.py context

                const serverData = JSON.parse('{{ games_json|escapejs }}');
                if (serverData.length > 0) {
                    games.value = serverData.map(game => ({
                        ...game,
                        matchScore: Math.floor(Math.random() * (99 - 70) + 70),
                    }));
                } else {
                    // Fallback to mock data if server data is empty
                    games.value = rawSaleData.map(game => ({
                        ...game,
                        matchScore: Math.floor(Math.random() * (99 - 70) + 70),
                        genre: "액션/RPG"
                    }));
                }
                // Initialize Wishlist
                try {
                    const wishlistData = JSON.parse('{{ wishlist_json|escapejs }}');
                    wishlist.value = wishlistData;
                } catch (e) {
                    console.error("Wishlist init failed", e);
                }

                // Fetch Community Posts
                await fetchPosts();
            });

            // --- Computed ---
            const popularGames = computed(() => games.value.slice(0, 5));

            const sortedSaleGames = computed(() => {
                let sorted = [...games.value];
                if (sortBy.value === 'interest') sorted.sort((a, b) => b.matchScore - a.matchScore);
                else if (sortBy.value === 'discount') sorted.sort((a, b) => b.discount_rate - a.discount_rate);
                else if (sortBy.value === 'price_asc') sorted.sort((a, b) => a.current_price - b.current_price);
                return sorted;
            });

            // --- Methods for CRUD & Auth ---

            const toggleAuthMode = () => {
                isLoginMode.value = !isLoginMode.value;
                authForm.email = '';
                authForm.password = '';
                authForm.nickname = '';
            };

            const handleAuthAction = () => {
                // Backend Integration Note: 
                // Replace this with axios.post('/api/login/' or '/api/register/', authForm)

                if (!authForm.email || !authForm.password) {
                    alert('이메일과 비밀번호를 입력해주세요.');
                    return;
                }
                // ... implementation details ...
            };

            const handleLogout = () => {
                // Redirect to Django logout URL
                window.location.href = "{% url 'users:logout' %}";
            };

            const deleteAccount = () => {
                // Redirect/Form submit to Django delete URL
                if (confirm("정말로 탈퇴하시겠습니까? 모든 데이터가 삭제됩니다.")) {
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = "{% url 'users:delete' %}";
                    const csrf = document.createElement('input');
                    csrf.type = 'hidden';
                    csrf.name = 'csrfmiddlewaretoken';
                    csrf.value = '{{ csrf_token }}';
                    form.appendChild(csrf);
                    document.body.appendChild(form);
                    form.submit();
                }
            };

            const socialLogin = (provider) => {
                alert(`${provider} 로그인 연동 기능은 준비 중입니다.`);
            };

            const toggleLink = (provider) => {
                // Toggle Linked Account Status (Update)
                if (provider === 'steam') {
                    user.value.linked_steam = !user.value.linked_steam;
                }
            };

            // --- Community Methods ---
            const fetchPosts = async () => {
                try {
                    let url = '/community/posts/';
                    if (communityCategory.value !== 'all') {
                        url += `?category=${communityCategory.value}`;
                    }
                    const response = await fetch(url);
                    if (response.ok) {
                        const data = await response.json();
                        communityPosts.value = data.map(post => ({
                            id: post.id,
                            title: post.title,
                            content: post.content,
                            author: post.author_name || '익명',
                            category: post.category,
                            created_at: new Date(post.created_at).toLocaleDateString(),
                            likes: post.likes_count || 0,
                            comments: post.comments_count || 0,
                            image: post.image || null,
                            video: post.video || null
                        }));
                    }
                } catch (e) {
                    console.error("Failed to fetch posts", e);
                }
            };

            const handleFileUpload = (event) => {
                newPost.file = event.target.files[0];
            };

            const submitPost = async () => {
                if (!newPost.title || !newPost.content) return alert('제목과 내용을 입력해주세요.');

                try {
                    const formData = new FormData();
                    formData.append('title', newPost.title);
                    formData.append('content', newPost.content);
                    formData.append('category', newPost.category);
                    if (newPost.file) {
                        if (newPost.file.type.startsWith('image/')) {
                            formData.append('image', newPost.file);
                        } else if (newPost.file.type.startsWith('video/')) {
                            formData.append('video', newPost.file);
                        }
                    }

                    const response = await fetch('/community/posts/', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: formData
                    });

                    if (response.ok) {
                        isWritingPost.value = false;
                        newPost.title = '';
                        newPost.content = '';
                        newPost.file = null;
                        if (fileInput.value) fileInput.value.value = '';
                        await fetchPosts();
                    } else {
                        alert('게시글 작성 실패');
                    }
                } catch (e) {
                    console.error(e);
                }
            };

            const openPostDetail = (post) => {
                selectedPost.value = post;
                document.body.style.overflow = 'hidden';
            };

            const closePostDetail = () => {
                selectedPost.value = null;
                document.body.style.overflow = '';
            };

            // Watch category change
            Vue.watch(communityCategory, () => {
                fetchPosts();
            });

            // --- Feature Methods ---

            const toggleWishlist = (game) => {
                const index = wishlist.value.findIndex(id => id === game.game_id);
                if (index === -1) {
                    wishlist.value.push(game.game_id);
                } else {
                    wishlist.value.splice(index, 1);
                }
            };

            const isWishlisted = (gameId) => {
                return wishlist.value.includes(gameId);
            };

            const formatPrice = (price) => price ? price.toLocaleString() : '무료';
            const handleImageError = (e) => { e.target.src = "https://via.placeholder.com/460x215?text=No+Image"; };
            const goToHome = () => {
                currentStep.value = 'main';
                currentTab.value = 'home';
            };

            return {
                // State
                currentStep,
                currentTab,
                user,
                authForm,
                isLoginMode,
                popularGames,
                sortedSaleGames,
                sortBy,
                wishlist,
                communityPosts,
                isWritingPost,
                communityCategory,
                newPost,
                selectedPost,
                fileInput,

                // Methods
                fetchPosts,
                submitPost,
                handleFileUpload,
                openPostDetail,
                closePostDetail,

                // Methods
                toggleAuthMode,
                handleAuthAction,
                handleLogout,
                deleteAccount,
                socialLogin,
                toggleLink,
                toggleWishlist,
                isWishlisted,
                formatPrice,
                handleImageError,
                goToHome
            };
        }
    }).mount('#app');
</script>
{% endblock %}