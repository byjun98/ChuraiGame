{% extends 'base.html' %}

{% block content %}
{% verbatim %}
<div id="gameDetailApp" class="max-w-7xl mx-auto px-4 sm:px-6 py-8">
    <!-- Back Button -->
    <a href="/" class="inline-flex items-center text-gray-500 hover:text-gray-900 mb-6 transition-colors">
        <i class="ph-bold ph-arrow-left mr-2"></i> Î©îÏù∏ÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞
    </a>

    <!-- Loading State -->
    <div v-if="isLoading" class="bg-white rounded-[2.5rem] shadow-sm border border-gray-100 overflow-hidden">
        <!-- Skeleton Header -->
        <div class="relative h-96 bg-gray-800 animate-pulse">
            <div class="absolute bottom-0 left-0 w-full p-8 sm:p-12">
                <div class="flex gap-3 mb-4">
                    <div class="h-7 w-20 bg-gray-600 rounded-full"></div>
                    <div class="h-7 w-16 bg-gray-600 rounded-full"></div>
                </div>
                <div class="h-12 w-2/3 bg-gray-600 rounded-xl mb-4"></div>
                <div class="h-5 w-1/3 bg-gray-700 rounded"></div>
            </div>
        </div>
        <div class="p-8 sm:p-12 space-y-8">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="aspect-video bg-gray-200 rounded-xl animate-pulse"></div>
                <div class="aspect-video bg-gray-200 rounded-xl animate-pulse"></div>
                <div class="aspect-video bg-gray-200 rounded-xl animate-pulse"></div>
                <div class="aspect-video bg-gray-200 rounded-xl animate-pulse"></div>
            </div>
            <div class="h-40 bg-gray-100 rounded-xl animate-pulse"></div>
        </div>
    </div>

    <!-- Error State -->
    <div v-else-if="error"
        class="bg-white rounded-[2.5rem] shadow-sm border border-red-100 overflow-hidden p-12 text-center">
        <i class="ph-duotone ph-warning-circle text-6xl text-red-400 mb-4"></i>
        <h2 class="text-2xl font-bold text-gray-800 mb-2">Í≤åÏûÑÏùÑ Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§</h2>
        <p class="text-gray-500 mb-6">{{ error }}</p>
        <a href="/" class="px-6 py-3 bg-blue-600 text-white rounded-xl font-medium hover:bg-blue-700 transition-colors">
            Î©îÏù∏ÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞
        </a>
    </div>

    <!-- Game Content -->
    <div v-else-if="game" class="bg-white rounded-[2.5rem] shadow-sm border border-gray-100 overflow-hidden">
        <!-- Game Header -->
        <div class="relative h-96 bg-gray-900">
            <img v-if="game.background_image" :src="game.background_image" :alt="game.name"
                class="w-full h-full object-cover opacity-50">
            <div class="absolute inset-0 bg-gradient-to-t from-black via-black/60 to-transparent"></div>
            <div class="absolute bottom-0 left-0 w-full p-8 sm:p-12">
                <div class="flex flex-col sm:flex-row sm:items-end justify-between gap-6">
                    <div class="flex-1">
                        <div class="flex flex-wrap items-center gap-3 mb-4">
                            <span v-if="primaryGenre"
                                class="inline-block px-4 py-1.5 bg-gradient-to-r from-blue-600 to-blue-500 text-white text-xs font-bold rounded-full shadow-lg shadow-blue-900/50">
                                {{ primaryGenre }}
                            </span>
                            <span v-if="game.metacritic"
                                class="inline-block px-4 py-1.5 bg-gradient-to-r from-green-600 to-green-500 text-white text-xs font-bold rounded-full shadow-lg">
                                <i class="ph-fill ph-trophy mr-1"></i> {{ game.metacritic }}
                            </span>
                            <span v-if="isRawgOnly"
                                class="inline-block px-4 py-1.5 bg-gradient-to-r from-purple-600 to-purple-500 text-white text-xs font-bold rounded-full shadow-lg">
                                <i class="ph-fill ph-globe mr-1"></i> RAWG Îç∞Ïù¥ÌÑ∞
                            </span>
                        </div>
                        <h1 class="text-4xl sm:text-5xl font-black text-white mb-3 tracking-tight drop-shadow-2xl">
                            {{ game.name }}
                        </h1>
                        <div class="flex items-center gap-4 text-gray-300 text-sm font-medium flex-wrap">
                            <span v-if="game.rating" class="flex items-center gap-1">
                                <i class="ph-fill ph-star text-yellow-400"></i>
                                {{ game.rating.toFixed(1) }}/5 (RAWG)
                            </span>
                            <span v-if="game.released" class="flex items-center gap-1">
                                <i class="ph-fill ph-calendar"></i> {{ game.released }}
                            </span>
                            <span v-if="game.playtime" class="flex items-center gap-1">
                                <i class="ph-fill ph-clock"></i> ÌèâÍ∑† {{ game.playtime }}ÏãúÍ∞Ñ
                            </span>
                        </div>
                    </div>
                    <!-- Rating Buttons (Netflix Style) -->
                    <div class="flex flex-col gap-3">
                        <!-- ÌèâÍ∞Ä Î≤ÑÌäºÎì§ -->
                        <div class="flex gap-2">
                            <button @click="rateGame(-1)"
                                :class="userRating === -1 ? 'bg-red-500 text-white scale-110' : 'bg-white/20 text-white hover:bg-red-500'"
                                class="w-12 h-12 rounded-full flex items-center justify-center transition-all duration-200 backdrop-blur-sm shadow-lg"
                                title="Î≥ÑÎ°úÏòàÏöî">
                                <i class="ph-fill ph-thumbs-down text-xl"></i>
                            </button>
                            <button @click="rateGame(3.5)"
                                :class="userRating === 3.5 ? 'bg-blue-500 text-white scale-110' : 'bg-white/20 text-white hover:bg-blue-500'"
                                class="w-12 h-12 rounded-full flex items-center justify-center transition-all duration-200 backdrop-blur-sm shadow-lg"
                                title="Ïû¨Î∞åÏñ¥Ïöî">
                                <i class="ph-fill ph-thumbs-up text-xl"></i>
                            </button>
                            <button @click="rateGame(5)"
                                :class="userRating === 5 ? 'bg-yellow-500 text-white scale-110' : 'bg-white/20 text-white hover:bg-yellow-500'"
                                class="w-12 h-12 rounded-full flex items-center justify-center transition-all duration-200 backdrop-blur-sm shadow-lg"
                                title="Ïù∏ÏÉùÍ≤åÏûÑ!">
                                <span class="font-bold">üëçüëç</span>
                            </button>
                        </div>
                        <div v-if="userRating" class="text-center text-white text-sm font-medium">
                            <span v-if="userRating === -1">üòê Î≥ÑÎ°úÏòàÏöî</span>
                            <span v-else-if="userRating === 3.5">üëç Ïû¨Î∞åÏñ¥Ïöî</span>
                            <span v-else-if="userRating === 5">üî• Ïù∏ÏÉùÍ≤åÏûÑ!</span>
                        </div>
                    </div>
                </div>
                <div class="flex gap-3 flex-wrap mt-4">
                    <a v-if="steamStoreUrl" :href="steamStoreUrl" target="_blank"
                        class="px-6 py-3 bg-gradient-to-r from-[#1b2838] to-[#2a475e] hover:from-[#2a475e] hover:to-[#3d6a8c] text-white rounded-xl font-bold flex items-center gap-2 transition-all shadow-lg hover:shadow-xl active:scale-95">
                        <i class="ph-fill ph-steam-logo text-xl"></i>
                        Steam ÏÉÅÏ†ê
                    </a>
                    <a v-if="game.slug" :href="`https://rawg.io/games/${game.slug}`" target="_blank"
                        class="px-6 py-3 bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white rounded-xl font-bold flex items-center gap-2 transition-all shadow-lg hover:shadow-xl active:scale-95">
                        <i class="ph-fill ph-globe text-xl"></i>
                        RAWGÏóêÏÑú Î≥¥Í∏∞
                    </a>
                    <!-- Steam Store Direct Link (fallback if steamStoreUrl not available) -->
                    <a v-if="!steamStoreUrl && steamAppId" :href="`https://store.steampowered.com/app/${steamAppId}/`"
                        target="_blank"
                        class="px-6 py-3 bg-gradient-to-r from-[#1b2838] to-[#2a475e] hover:from-[#2a475e] hover:to-[#3d6a8c] text-white rounded-xl font-bold flex items-center gap-2 transition-all shadow-lg hover:shadow-xl active:scale-95">
                        <i class="ph-fill ph-steam-logo text-xl"></i>
                        Steam ÏÉÅÏ†ê
                    </a>
                    <!-- CheapShark Direct Deal Button (if redirect URL is available - goes directly to cheapest store) -->
                    <a v-if="cheapsharkRedirectUrl" :href="cheapsharkRedirectUrl" target="_blank"
                        class="px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white rounded-xl font-bold flex items-center gap-2 transition-all shadow-lg hover:shadow-xl active:scale-95">
                        <i class="ph-bold ph-lightning text-xl"></i>
                        <span class="flex flex-col items-start leading-tight">
                            <span class="text-xs opacity-80">ÏµúÏ†ÄÍ∞Ä</span>
                            <span>Î∞îÎ°ú Íµ¨Îß§</span>
                        </span>
                    </a>
                    <!-- CheapShark Price Comparison (fallback - shows all store prices) -->
                    <a v-else-if="steamAppId" :href="`https://www.cheapshark.com/browse/games?steamAppID=${steamAppId}`"
                        target="_blank"
                        class="px-6 py-3 bg-gradient-to-r from-pink-600 to-orange-500 hover:from-pink-700 hover:to-orange-600 text-white rounded-xl font-bold flex items-center gap-2 transition-all shadow-lg hover:shadow-xl active:scale-95">
                        <i class="ph-bold ph-storefront text-xl"></i>
                        <span class="flex flex-col items-start leading-tight">
                            <span class="text-xs opacity-80">CheapShark</span>
                            <span>ÏµúÏ†ÄÍ∞Ä ÎπÑÍµê</span>
                        </span>
                    </a>
                </div>
            </div>
        </div>


        <!-- Content -->
        <div class="p-8 sm:p-12 space-y-12">

            <!-- Screenshots Gallery -->
            <div v-if="screenshots.length > 0">
                <h3 class="text-2xl font-bold mb-6 flex items-center gap-2">
                    <i class="ph-fill ph-images text-blue-600"></i>
                    Ïä§ÌÅ¨Î¶∞ÏÉ∑
                </h3>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    <div v-for="(screenshot, index) in screenshots" :key="index"
                        class="group relative aspect-video rounded-xl overflow-hidden bg-gray-100 cursor-pointer hover:ring-4 hover:ring-blue-500 transition-all"
                        @click="openImageModal(screenshot.image)">
                        <img :src="screenshot.image" alt="Ïä§ÌÅ¨Î¶∞ÏÉ∑"
                            class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300">
                        <div class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-colors"></div>
                    </div>
                </div>
            </div>

            <!-- Loading Screenshots -->
            <div v-else-if="isLoadingDetails" class="space-y-4">
                <h3 class="text-2xl font-bold flex items-center gap-2">
                    <i class="ph-fill ph-images text-blue-600"></i>
                    Ïä§ÌÅ¨Î¶∞ÏÉ∑
                    <div class="w-5 h-5 border-2 border-blue-500 border-t-transparent rounded-full animate-spin ml-2">
                    </div>
                </h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div v-for="n in 4" :key="n" class="aspect-video bg-gray-200 rounded-xl animate-pulse"></div>
                </div>
            </div>

            <!-- Main Content Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-12">
                <!-- Left: Description -->
                <div class="lg:col-span-2 space-y-10">

                    <!-- Game Description -->
                    <div v-if="game.description_raw || game.description">
                        <h3 class="text-2xl font-bold mb-4 flex items-center gap-2">
                            <i class="ph-fill ph-book-open text-blue-600"></i>
                            Í≤åÏûÑ ÏÜåÍ∞ú
                        </h3>
                        <div
                            class="prose prose-sm max-w-none text-gray-600 leading-relaxed bg-gray-50 rounded-xl p-6 border border-gray-100">
                            <div v-html="formatDescription(game.description_raw || game.description)"></div>

                            <!-- Translation Toggle Button -->
                            <div class="mt-4 pt-4 border-t border-gray-200">
                                <button @click="toggleTranslation" :disabled="isTranslating"
                                    class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-lg transition-all duration-200"
                                    :class="showTranslation 
                                        ? 'bg-blue-100 text-blue-700 hover:bg-blue-200' 
                                        : 'bg-transparent text-gray-500 hover:bg-gray-100 hover:text-gray-700 border border-gray-200'">
                                    <i v-if="isTranslating" class="ph-bold ph-spinner animate-spin"></i>
                                    <i v-else-if="showTranslation" class="ph-fill ph-globe"></i>
                                    <i v-else class="ph-bold ph-translate"></i>
                                    <span v-if="isTranslating">Î≤àÏó≠ Ï§ë...</span>
                                    <span v-else-if="showTranslation">ÏõêÎ¨∏ Î≥¥Í∏∞</span>
                                    <span v-else>ÌïúÍµ≠Ïñ¥Î°ú Î≤àÏó≠</span>
                                </button>
                            </div>

                            <!-- Translated Content -->
                            <div v-if="showTranslation && translatedDescription"
                                class="mt-4 p-4 bg-blue-50 rounded-xl border border-blue-100">
                                <div class="flex items-center gap-2 mb-3 text-blue-600 text-sm font-medium">
                                    <i class="ph-fill ph-globe"></i>
                                    <span>AI ÌïúÍµ≠Ïñ¥ Î≤àÏó≠</span>
                                </div>
                                <div class="text-gray-700 leading-relaxed"
                                    v-html="formatDescription(translatedDescription)"></div>
                            </div>

                            <!-- Translation Error -->
                            <div v-if="translationError"
                                class="mt-4 p-3 bg-red-50 rounded-lg border border-red-100 text-red-600 text-sm">
                                <i class="ph-bold ph-warning mr-2"></i>
                                {{ translationError }}
                            </div>
                        </div>
                    </div>
                    <div v-else-if="isLoadingDetails">
                        <h3 class="text-2xl font-bold mb-4 flex items-center gap-2">
                            <i class="ph-fill ph-book-open text-blue-600"></i>
                            Í≤åÏûÑ ÏÜåÍ∞ú
                            <div
                                class="w-5 h-5 border-2 border-blue-500 border-t-transparent rounded-full animate-spin ml-2">
                            </div>
                        </h3>
                        <div class="h-40 bg-gray-100 rounded-xl animate-pulse"></div>
                    </div>

                    <!-- RAWG ÏïàÎÇ¥ -->
                    <div v-if="isRawgOnly"
                        class="bg-gradient-to-br from-purple-50 to-indigo-50 rounded-2xl p-6 border border-purple-100">
                        <h3 class="text-lg font-bold mb-3 flex items-center gap-2">
                            <i class="ph-fill ph-info text-purple-600"></i>
                            RAWG Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Í≤åÏûÑ
                        </h3>
                        <p class="text-gray-600 text-sm leading-relaxed">
                            Ïù¥ Í≤åÏûÑÏùÄ RAWG APIÏóêÏÑú Í∞ÄÏ†∏Ïò® Ï†ïÎ≥¥ÏûÖÎãàÎã§.
                        </p>
                    </div>
                </div>

                <!-- Right: Info Sidebar -->
                <div class="space-y-6">
                    <div
                        class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-2xl p-6 border border-gray-200 sticky top-6">
                        <h3 class="font-bold text-gray-900 mb-4 flex items-center gap-2">
                            <i class="ph-fill ph-info text-blue-600"></i>
                            Í≤åÏûÑ Ï†ïÎ≥¥
                        </h3>
                        <dl class="space-y-3 text-sm">
                            <div v-if="allGenres" class="flex justify-between items-start">
                                <dt class="text-gray-500 font-medium">Ïû•Î•¥</dt>
                                <dd class="font-bold text-gray-900 text-right">{{ allGenres }}</dd>
                            </div>
                            <div v-if="game.metacritic" class="flex justify-between items-start">
                                <dt class="text-gray-500 font-medium">Î©îÌÉÄÌÅ¨Î¶¨Ìã±</dt>
                                <dd class="font-bold text-green-600 text-right">{{ game.metacritic }}/100</dd>
                            </div>
                            <div v-if="game.rating" class="flex justify-between items-start">
                                <dt class="text-gray-500 font-medium">RAWG ÌèâÏ†ê</dt>
                                <dd class="font-bold text-yellow-600 text-right">{{ game.rating.toFixed(1) }}/5</dd>
                            </div>
                            <div v-if="game.released" class="flex justify-between items-start">
                                <dt class="text-gray-500 font-medium">Ï∂úÏãúÏùº</dt>
                                <dd class="font-medium text-gray-600 text-right">{{ game.released }}</dd>
                            </div>
                            <div v-if="game.developers && game.developers.length > 0"
                                class="flex justify-between items-start">
                                <dt class="text-gray-500 font-medium">Í∞úÎ∞úÏÇ¨</dt>
                                <dd class="font-medium text-gray-600 text-right">
                                    {{ game.developers.map(d => d.name).join(', ') }}
                                </dd>
                            </div>
                            <div v-if="game.publishers && game.publishers.length > 0"
                                class="flex justify-between items-start">
                                <dt class="text-gray-500 font-medium">ÌçºÎ∏îÎ¶¨ÏÖî</dt>
                                <dd class="font-medium text-gray-600 text-right">
                                    {{ game.publishers.map(p => p.name).join(', ') }}
                                </dd>
                            </div>
                            <div class="flex justify-between items-start">
                                <dt class="text-gray-500 font-medium">RAWG ID</dt>
                                <dd class="font-medium text-gray-600 text-right">
                                    <a :href="`https://rawg.io/games/${game.id}`" target="_blank"
                                        class="hover:text-blue-600 transition-colors">
                                        {{ game.id }} <i class="ph-bold ph-arrow-square-out text-xs"></i>
                                    </a>
                                </dd>
                            </div>
                        </dl>

                        <!-- Platforms -->
                        <div v-if="game.platforms && game.platforms.length > 0"
                            class="mt-6 pt-6 border-t border-gray-200">
                            <h4 class="text-xs font-bold text-gray-500 mb-3">ÌîåÎû´Ìèº</h4>
                            <div class="flex flex-wrap gap-2">
                                <span v-for="p in game.platforms" :key="p.platform.id"
                                    class="px-2 py-1 bg-gray-200 text-gray-700 text-xs font-medium rounded-lg">
                                    {{ p.platform.name }}
                                </span>
                            </div>
                        </div>

                        <!-- Stats -->
                        <div v-if="screenshots.length > 0" class="mt-6 pt-6 border-t border-gray-200">
                            <div class="grid grid-cols-2 gap-4 text-center">
                                <div>
                                    <div class="text-2xl font-black text-blue-600">{{ screenshots.length }}</div>
                                    <div class="text-xs text-gray-500 font-medium">Ïä§ÌÅ¨Î¶∞ÏÉ∑</div>
                                </div>
                                <div v-if="game.added">
                                    <div class="text-2xl font-black text-purple-600">{{ formatNumber(game.added) }}
                                    </div>
                                    <div class="text-xs text-gray-500 font-medium">ÎùºÏù¥Î∏åÎü¨Î¶¨</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Image Modal -->
<div id="imageModal" class="fixed inset-0 bg-black/90 z-50 hidden items-center justify-center p-4"
    onclick="closeImageModal()">
    <div class="relative max-w-6xl max-h-[90vh]">
        <button onclick="closeImageModal()"
            class="absolute -top-12 right-0 text-white hover:text-gray-300 transition-colors">
            <i class="ph-bold ph-x text-3xl"></i>
        </button>
        <img id="modalImage" src="" alt="Screenshot" class="max-w-full max-h-[85vh] rounded-lg shadow-2xl">
    </div>
</div>
{% endverbatim %}

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script>
    const { createApp, ref, computed, onMounted } = Vue;

    createApp({
        setup() {
            const game = ref(null);
            const screenshots = ref([]);
            const steamStoreUrl = ref(null);
            const isLoading = ref(true);
            const isLoadingDetails = ref(false);
            const isRawgOnly = ref(true);
            const error = ref(null);

            // Extract game ID from URL
            const pathParts = window.location.pathname.split('/');
            const gameId = pathParts[pathParts.length - 2] || pathParts[pathParts.length - 1];

            // Extract numeric ID
            const numericId = gameId.replace(/\D/g, '');

            // Check if this is a Steam game (app123 format) or get from query params
            const urlParams = new URLSearchParams(window.location.search);
            const steamAppIdFromUrl = urlParams.get('steam_appid');
            const steamAppId = ref(steamAppIdFromUrl || (gameId.startsWith('app') ? numericId : null));

            // CheapShark redirect URL (directly goes to the cheapest store)
            const cheapsharkRedirectUrl = ref(urlParams.get('cheapshark_url') || null);

            // Translation state
            const showTranslation = ref(false);
            const translatedDescription = ref('');
            const isTranslating = ref(false);
            const translationError = ref('');

            // User rating state
            const userRating = ref(null);


            // Computed properties for genres
            const primaryGenre = computed(() => {
                if (game.value && game.value.genres && game.value.genres.length > 0) {
                    return game.value.genres[0].name || game.value.genres[0];
                }
                return null;
            });

            const allGenres = computed(() => {
                if (game.value && game.value.genres && game.value.genres.length > 0) {
                    return game.value.genres.map(g => g.name || g).join(', ');
                }
                return null;
            });

            const formatDescription = (text) => {
                if (!text) return '';
                // Convert newlines to paragraphs
                return text.split('\n\n').map(p => `<p class="mb-4">${p}</p>`).join('');
            };

            const formatNumber = (num) => {
                if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
                if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
                return num.toString();
            };

            const openImageModal = (imageUrl) => {
                const modal = document.getElementById('imageModal');
                const modalImage = document.getElementById('modalImage');
                modalImage.src = imageUrl;
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            };

            const toggleTranslation = async () => {
                // If already have translation, just toggle visibility
                if (translatedDescription.value) {
                    showTranslation.value = !showTranslation.value;
                    return;
                }

                // Need to fetch translation
                if (!game.value || (!game.value.description_raw && !game.value.description)) {
                    return;
                }

                isTranslating.value = true;
                translationError.value = '';

                try {
                    const textToTranslate = game.value.description_raw || game.value.description;

                    const response = await fetch('/users/api/translate/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({ text: textToTranslate })
                    });

                    const data = await response.json();

                    if (data.success && data.translated) {
                        translatedDescription.value = data.translated;
                        showTranslation.value = true;
                    } else {
                        translationError.value = data.error || 'Î≤àÏó≠Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.';
                    }
                } catch (e) {
                    console.error('Translation error:', e);
                    translationError.value = 'Î≤àÏó≠ ÏöîÏ≤≠ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.';
                } finally {
                    isTranslating.value = false;
                }
            };

            // Rate game function (saves to DB for recommendations)
            const rateGame = async (score) => {
                if (!game.value) return;

                // Toggle off if same score clicked
                if (userRating.value === score) {
                    userRating.value = null;
                    return;
                }

                userRating.value = score;

                try {
                    const response = await fetch('/users/api/onboarding/rate/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken()
                        },
                        body: JSON.stringify({
                            game_id: game.value.id,
                            game_title: game.value.name,
                            game_image: game.value.background_image || '',
                            score: score
                        })
                    });

                    if (response.ok) {
                        console.log('Rating saved:', score);
                    } else {
                        console.error('Failed to save rating');
                    }
                } catch (e) {
                    console.error('Error saving rating:', e);
                }
            };

            // Get CSRF token
            const getCsrfToken = () => {
                const name = 'csrftoken';
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    const [key, value] = cookie.trim().split('=');
                    if (key === name) return value;
                }
                return '';
            };

            // Fetch existing user rating
            const fetchUserRating = async (rawgId) => {
                try {
                    const response = await fetch(`/users/api/game-rating/${rawgId}/`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.score !== undefined && data.score !== null) {
                            userRating.value = data.score;
                        }
                    }
                } catch (e) {
                    // Silently fail if not logged in or no rating
                }
            };

            const fetchGameData = async () => {

                try {
                    isLoading.value = true;

                    // Check if we're searching by title (from sale tab)
                    const searchTitle = urlParams.get('title');
                    let rawgId = numericId;

                    if (searchTitle) {
                        // Search RAWG by game title with exact match
                        const searchUrl = `https://api.rawg.io/api/games?key={{ rawg_api_key }}&search=${encodeURIComponent(searchTitle)}&search_exact=true&page_size=1`;
                        const searchResponse = await fetch(searchUrl);

                        if (searchResponse.ok) {
                            const searchData = await searchResponse.json();
                            if (searchData.results && searchData.results.length > 0) {
                                rawgId = searchData.results[0].id;
                            } else {
                                // Fallback: try without exact match
                                const fuzzyUrl = `https://api.rawg.io/api/games?key={{ rawg_api_key }}&search=${encodeURIComponent(searchTitle)}&page_size=1`;
                                const fuzzyResponse = await fetch(fuzzyUrl);
                                if (fuzzyResponse.ok) {
                                    const fuzzyData = await fuzzyResponse.json();
                                    if (fuzzyData.results && fuzzyData.results.length > 0) {
                                        rawgId = fuzzyData.results[0].id;
                                    } else {
                                        throw new Error(`'${searchTitle}' Í≤åÏûÑÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.`);
                                    }
                                }
                            }
                        }
                    }

                    // Fetch basic game info using RAWG ID
                    const response = await fetch(`https://api.rawg.io/api/games/${rawgId}?key={{ rawg_api_key }}`);
                    if (!response.ok) throw new Error('Í≤åÏûÑÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');

                    const data = await response.json();
                    game.value = data;
                    isLoading.value = false;

                    // Fetch screenshots and stores in background (lazy loading)
                    isLoadingDetails.value = true;

                    // Fetch screenshots
                    const screenshotsResponse = await fetch(`https://api.rawg.io/api/games/${rawgId}/screenshots?key={{ rawg_api_key }}&page_size=8`);
                    if (screenshotsResponse.ok) {
                        const ssData = await screenshotsResponse.json();
                        screenshots.value = ssData.results || [];
                    }

                    // Fetch stores to get Steam link
                    try {
                        const storesResponse = await fetch(`https://api.rawg.io/api/games/${rawgId}/stores?key={{ rawg_api_key }}`);
                        if (storesResponse.ok) {
                            const storesData = await storesResponse.json();
                            // Find Steam store (store_id 1 = Steam)
                            const steamStore = storesData.results?.find(s => s.store_id === 1);
                            if (steamStore && steamStore.url) {
                                steamStoreUrl.value = steamStore.url;
                                // Extract Steam AppID from URL if not already set
                                if (!steamAppId.value) {
                                    const appIdMatch = steamStore.url.match(/\/app\/(\d+)/);
                                    if (appIdMatch && appIdMatch[1]) {
                                        steamAppId.value = appIdMatch[1];
                                    }
                                }
                            }
                        }
                    } catch (storeError) {
                        console.log('Could not fetch store info:', storeError);
                    }

                    isLoadingDetails.value = false;

                    // Fetch user's existing rating for this game
                    fetchUserRating(rawgId);

                } catch (e) {
                    console.error('Failed to fetch game:', e);
                    error.value = e.message;
                    isLoading.value = false;
                }
            };

            onMounted(() => {
                fetchGameData();
            });

            return {
                game,
                screenshots,
                steamStoreUrl,
                steamAppId,
                cheapsharkRedirectUrl,
                isLoading,
                isLoadingDetails,
                isRawgOnly,
                error,
                primaryGenre,
                allGenres,
                formatDescription,
                formatNumber,
                openImageModal,
                // Translation
                showTranslation,
                translatedDescription,
                isTranslating,
                translationError,
                toggleTranslation,
                // Rating
                userRating,
                rateGame
            };
        }
    }).mount('#gameDetailApp');

    function closeImageModal() {
        const modal = document.getElementById('imageModal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }

    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
            closeImageModal();
        }
    });
</script>
{% endblock %}