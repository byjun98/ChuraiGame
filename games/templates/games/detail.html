{% extends 'base.html' %}

{% block content %}
{% include 'games/components/header.html' %}

<div id="gameDetailApp" class="max-w-7xl mx-auto px-4 sm:px-6 py-8">

    <div class="bg-white rounded-[2.5rem] shadow-sm border border-gray-100 overflow-hidden">
        <!-- Game Header with Background -->
        <div class="relative h-96 bg-gray-900">
            <!-- ë°°ê²½ ì´ë¯¸ì§€: DBì— ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ JSë¡œ RAWGì—ì„œ ê°€ì ¸ì˜´ -->
            {% if game.background_image %}
            <img id="headerImage" src="{{ game.background_image }}" alt="{{ game.title }}"
                class="w-full h-full object-cover opacity-50">
            {% elif game.image_url %}
            <img id="headerImage" src="{{ game.image_url }}" alt="{{ game.title }}"
                class="w-full h-full object-cover opacity-60">
            {% else %}
            <img id="headerImage" src="" alt="{{ game.title }}" class="w-full h-full object-cover opacity-50 hidden">
            <div id="headerPlaceholder" class="w-full h-full bg-gradient-to-br from-gray-800 to-gray-900 animate-pulse">
            </div>
            {% endif %}
            <div class="absolute inset-0 bg-gradient-to-t from-black via-black/60 to-transparent"></div>
            <div class="absolute bottom-0 left-0 w-full p-8 sm:p-12">
                <div class="flex flex-col sm:flex-row sm:items-end justify-between gap-6">
                    <div class="flex-1">
                        <div class="flex flex-wrap items-center gap-3 mb-4" id="badgeContainer">
                            <!-- ì¥ë¥´ ë°°ì§€: DBì— ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ JSë¡œ ì—…ë°ì´íŠ¸ -->
                            <span id="genreBadge"
                                class="inline-block px-4 py-1.5 bg-gradient-to-r from-blue-600 to-blue-500 text-white text-xs font-bold rounded-full shadow-lg shadow-blue-900/50">
                                {% if game.genre and game.genre != 'ê²Œì„' and game.genre != 'Unknown' %}
                                {{ game.genre }}
                                {% else %}
                                <span class="flex items-center gap-1">
                                    <div
                                        class="w-3 h-3 border-2 border-white border-t-transparent rounded-full animate-spin">
                                    </div>
                                    ë¡œë”©ì¤‘
                                </span>
                                {% endif %}
                            </span>
                            {% if game.metacritic_score %}
                            <span
                                class="inline-block px-4 py-1.5 bg-gradient-to-r from-green-600 to-green-500 text-white text-xs font-bold rounded-full shadow-lg">
                                <i class="ph-fill ph-trophy mr-1"></i> {{ game.metacritic_score }}
                            </span>
                            {% endif %}
                            <!-- RAWG ë©”íƒ€í¬ë¦¬í‹± (DBì— ì—†ì„ ê²½ìš° JSë¡œ ì¶”ê°€) -->
                            <span id="rawgMetacriticBadge"
                                class="hidden inline-block px-4 py-1.5 bg-gradient-to-r from-green-600 to-green-500 text-white text-xs font-bold rounded-full shadow-lg">
                                <i class="ph-fill ph-trophy mr-1"></i> <span id="rawgMetacriticValue"></span>
                            </span>
                        </div>
                        <h1 class="text-4xl sm:text-5xl font-black text-white mb-3 tracking-tight drop-shadow-2xl">
                            {{ game.title }}
                        </h1>
                        <div class="flex items-center gap-4 text-gray-300 text-sm font-medium flex-wrap">
                            <span class="flex items-center gap-1"><i class="ph-fill ph-star text-yellow-400"></i>
                                {{ game.rating_set.count }}ê°œì˜ í‰ê°€</span>
                            <!-- RAWG í‰ì  (JSë¡œ ì¶”ê°€) -->
                            <span id="rawgRating" class="hidden flex items-center gap-1">
                                <i class="ph-fill ph-star text-yellow-400"></i>
                                <span id="rawgRatingValue"></span>/5 (RAWG)
                            </span>
                            {% if game.steam_appid %}
                            <span class="flex items-center gap-1"><i class="ph-fill ph-game-controller"></i> Steam
                                AppID: {{ game.steam_appid }}</span>
                            {% endif %}
                            <!-- ì¶œì‹œì¼ (JSë¡œ ì¶”ê°€) -->
                            <span id="releasedDate" class="hidden flex items-center gap-1">
                                <i class="ph-fill ph-calendar"></i>
                                <span id="releasedValue"></span>
                            </span>
                        </div>
                    </div>
                    <!-- Rating Buttons (Netflix Style) -->
                    <div class="flex flex-col gap-3">
                        <!-- í‰ê°€ ë²„íŠ¼ë“¤ -->
                        <div class="flex gap-2">
                            <button onclick="rateGame(-1)" id="rateBtn-1"
                                class="rating-btn w-12 h-12 rounded-full flex items-center justify-center transition-all duration-200 backdrop-blur-sm shadow-lg bg-white/20 text-white hover:bg-red-500"
                                title="ë³„ë¡œì˜ˆìš”">
                                <i class="ph-fill ph-thumbs-down text-xl"></i>
                            </button>
                            <button onclick="rateGame(3.5)" id="rateBtn3.5"
                                class="rating-btn w-12 h-12 rounded-full flex items-center justify-center transition-all duration-200 backdrop-blur-sm shadow-lg bg-white/20 text-white hover:bg-blue-500"
                                title="ì¬ë°Œì–´ìš”">
                                <i class="ph-fill ph-thumbs-up text-xl"></i>
                            </button>
                            <button onclick="rateGame(5)" id="rateBtn5"
                                class="rating-btn w-12 h-12 rounded-full flex items-center justify-center transition-all duration-200 backdrop-blur-sm shadow-lg bg-white/20 text-white hover:bg-yellow-500"
                                title="ì¸ìƒê²Œì„!">
                                <span class="flex"><i class="ph-fill ph-thumbs-up text-lg"></i><i
                                        class="ph-fill ph-thumbs-up text-lg"></i></span>
                            </button>
                            <!-- ì°œ(í•˜íŠ¸) ë²„íŠ¼ -->
                            <button onclick="toggleWishlistDetail()" id="wishlistBtn"
                                class="wishlist-btn w-12 h-12 rounded-full flex items-center justify-center transition-all duration-200 backdrop-blur-sm shadow-lg bg-white/20 text-white hover:bg-pink-500"
                                title="ì°œí•˜ê¸°">
                                <i class="ph-fill ph-heart text-xl" id="wishlistIcon"></i>
                            </button>
                        </div>
                        <div id="ratingLabel" class="text-center text-white text-sm font-medium hidden"></div>
                    </div>
                </div>
                <div class="flex gap-3 flex-wrap mt-4">
                    {% if game.steam_appid %}
                    <a href="https://store.steampowered.com/app/{{ game.steam_appid }}" target="_blank"
                        class="px-6 py-3 bg-gradient-to-r from-[#1b2838] to-[#2a475e] hover:from-[#2a475e] hover:to-[#3d6a8c] text-white rounded-xl font-bold flex items-center gap-2 transition-all shadow-lg hover:shadow-xl active:scale-95">
                        <i class="ph-fill ph-steam-logo text-xl"></i>
                        Steam ìƒì 
                    </a>
                    {% endif %}

                    {% if game.rawg_id %}
                    <a href="https://rawg.io/games/{{ game.rawg_id }}" target="_blank"
                        class="px-6 py-3 bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white rounded-xl font-bold flex items-center gap-2 transition-all shadow-lg hover:shadow-xl active:scale-95">
                        <i class="ph-fill ph-globe text-xl"></i>
                        RAWGì—ì„œ ë³´ê¸°
                    </a>
                    {% endif %}

                    {% if game.steam_appid %}
                    <!-- CheapShark Price Comparison (APIë¡œ dealID ê°€ì ¸ì˜¤ê¸°) -->
                    <a id="cheapsharkBtn" href="#" onclick="return false;"
                        class="px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white rounded-xl font-bold flex items-center gap-2 transition-all shadow-lg hover:shadow-xl active:scale-95 opacity-50 cursor-wait"
                        title="ê°€ê²© ì •ë³´ ë¡œë”© ì¤‘...">
                        <i class="ph-bold ph-spinner animate-spin text-xl" id="cheapsharkIcon"></i>
                        <span class="flex flex-col items-start leading-tight">
                            <span class="text-xs opacity-80">ìµœì €ê°€</span>
                            <span id="cheapsharkText">ë¡œë”© ì¤‘...</span>
                        </span>
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Content -->
    <div class="p-8 sm:p-12 space-y-12">

        <!-- Screenshots Gallery -->
        {% if screenshots %}
        <div id="screenshotsSection">
            <h3 class="text-2xl font-bold mb-6 flex items-center gap-2">
                <i class="ph-fill ph-images text-blue-600"></i>
                ìŠ¤í¬ë¦°ìƒ·
            </h3>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" id="screenshotsGrid">
                {% for screenshot in screenshots %}
                <div
                    class="group relative aspect-video rounded-xl overflow-hidden bg-gray-100 cursor-pointer hover:ring-4 hover:ring-blue-500 transition-all"
                    onclick="openImageModal('{{ screenshot.image_url }}')">
                    <img src="{{ screenshot.image_url }}" alt="ìŠ¤í¬ë¦°ìƒ·"
                        class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300">
                    <div class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-colors pointer-events-none"></div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% else %}
        <!-- ìŠ¤í¬ë¦°ìƒ· ì—†ì„ ê²½ìš° RAWGì—ì„œ ë¡œë”© -->
        <div id="screenshotsSection">
            <h3 class="text-2xl font-bold mb-6 flex items-center gap-2">
                <i class="ph-fill ph-images text-blue-600"></i>
                ìŠ¤í¬ë¦°ìƒ·
                <div id="screenshotsLoader"
                    class="w-5 h-5 border-2 border-blue-500 border-t-transparent rounded-full animate-spin ml-2">
                </div>
            </h3>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" id="screenshotsGrid">
                <!-- JSë¡œ ì±„ì›Œì§ -->
                <div class="aspect-video bg-gray-200 rounded-xl animate-pulse"></div>
                <div class="aspect-video bg-gray-200 rounded-xl animate-pulse"></div>
                <div class="aspect-video bg-gray-200 rounded-xl animate-pulse"></div>
                <div class="aspect-video bg-gray-200 rounded-xl animate-pulse"></div>
            </div>
        </div>
        {% endif %}

        <!-- Trailers -->
        {% if trailers %}
        <div>
            <h3 class="text-2xl font-bold mb-6 flex items-center gap-2">
                <i class="ph-fill ph-play-circle text-blue-600"></i>
                íŠ¸ë ˆì¼ëŸ¬ & ì˜ìƒ
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                {% for trailer in trailers %}
                <div
                    class="bg-gray-50 rounded-xl overflow-hidden border border-gray-200 hover:border-blue-300 transition-colors">
                    <video controls class="w-full aspect-video bg-black" poster="{{ trailer.preview_url }}">
                        <source src="{{ trailer.data_max }}" type="video/mp4">
                        <source src="{{ trailer.data_480 }}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                    <div class="p-4">
                        <p class="font-semibold text-gray-800">{{ trailer.name }}</p>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-12">
            <!-- Left: Description & Reviews -->
            <div class="lg:col-span-2 space-y-10">

                <!-- Game Description -->
                <div id="descriptionSection">
                    <h3 class="text-2xl font-bold mb-4 flex items-center gap-2">
                        <i class="ph-fill ph-book-open text-blue-600"></i>
                        ê²Œì„ ì†Œê°œ
                    </h3>

                    <div
                        class="prose prose-sm max-w-none text-gray-600 leading-relaxed bg-gray-50 rounded-xl p-6 border border-gray-100">

                        <!-- Original Description (Hidden if KR exists by default) -->
                        <div id="originalDescription" class="{% if game.description_kr %}hidden{% endif %}">
                            {% if game.description %}
                            {{ game.description|linebreaks }}
                            {% else %}
                            <div id="descriptionLoader"
                                class="w-5 h-5 border-2 border-blue-500 border-t-transparent rounded-full animate-spin ml-2 mb-4">
                            </div>
                            <div class="h-4 bg-gray-200 rounded w-3/4 mb-2 animate-pulse"></div>
                            <div class="h-4 bg-gray-200 rounded w-full mb-2 animate-pulse"></div>
                            <div class="h-4 bg-gray-200 rounded w-5/6 animate-pulse"></div>
                            {% endif %}
                        </div>

                        <!-- Translated Content (Visible if KR exists) -->
                        <div id="translatedContent"
                            class="{% if not game.description_kr %}hidden{% endif %} p-4 bg-blue-50 rounded-xl border border-blue-100">
                            <div class="flex items-center gap-2 mb-3 text-blue-600 text-sm font-medium">
                                <i class="ph-fill ph-globe"></i>
                                <span>AI í•œêµ­ì–´ ë²ˆì—­</span>
                            </div>
                            <div id="translatedText" class="text-gray-700 leading-relaxed">
                                {% if game.description_kr %}
                                {{ game.description_kr|linebreaks }}
                                {% endif %}
                            </div>
                        </div>

                        <!-- Translation Toggle Button -->
                        <div class="mt-4 pt-4 border-t border-gray-200">
                            <button onclick="toggleTranslation()" id="translationBtn"
                                class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-lg transition-all duration-200 {% if game.description_kr %}bg-blue-100 text-blue-700 hover:bg-blue-200{% else %}bg-transparent text-gray-500 hover:bg-gray-100 hover:text-gray-700 border border-gray-200{% endif %}">
                                <i class="{% if game.description_kr %}ph-fill ph-globe{% else %}ph-bold ph-translate{% endif %}"
                                    id="translationIcon"></i>
                                <span id="translationText">
                                    {% if game.description_kr %}ì›ë¬¸ ë³´ê¸°{% else %}í•œêµ­ì–´ë¡œ ë²ˆì—­{% endif %}
                                </span>
                            </button>
                        </div>

                        <!-- Translation Error -->
                        <div id="translationError"
                            class="hidden mt-4 p-3 bg-red-50 rounded-lg border border-red-100 text-red-600 text-sm">
                            <i class="ph-bold ph-warning mr-2"></i>
                            <span id="translationErrorText"></span>
                        </div>
                    </div>
                </div>

                <!-- My Review Form -->
                <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl p-6 border border-blue-100">
                    <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                        <i class="ph-fill ph-pencil-simple text-blue-600"></i>
                        {{ my_rating|yesno:"ë‚´ í‰ê°€ ìˆ˜ì •í•˜ê¸°,ê²Œì„ í‰ê°€í•˜ê¸°" }}
                    </h3>
                    <form method="POST" class="space-y-4">
                        {% csrf_token %}
                        <div>
                            <label class="block text-xs font-bold text-gray-700 mb-2">ë³„ì </label>
                            <div class="flex gap-2 star-rating-container" id="starRatingContainer">
                                {% for i in "12345" %}
                                <label class="cursor-pointer group">
                                    <input type="radio" name="score" value="{{ forloop.counter }}" class="hidden peer"
                                        {% if my_rating and
                                        forloop.counter|floatformat:"0"==my_rating.score|floatformat:"0" %}checked{%
                                        endif %} required>
                                    <i
                                        class="ph-fill ph-star text-3xl text-gray-300 transition-colors review-star-icon"></i>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-700 mb-2">í•œì¤„í‰ <span
                                    class="text-gray-400 font-normal">(ì„ íƒ)</span></label>
                            <textarea name="comment" rows="2" placeholder="ì´ ê²Œì„ì— ëŒ€í•œ í•œë§ˆë””ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”."
                                class="w-full px-4 py-3 bg-white border border-gray-200 rounded-xl focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none transition-all resize-none text-sm">{{ my_rating.comment|default:'' }}</textarea>
                        </div>
                        <div class="flex justify-end">
                            <button type="submit"
                                class="px-6 py-2.5 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white rounded-xl font-bold text-sm shadow-lg shadow-blue-200 transition-all active:scale-95">
                                ë“±ë¡í•˜ê¸°
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Steam Reviews Section -->
                {% if steam_reviews %}
                <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-6 border border-slate-700">
                    <h3 class="text-xl font-bold mb-6 flex items-center gap-2 text-white">
                        <i class="ph-fill ph-steam-logo text-[#66c0f4]"></i>
                        Steam ìœ ì € ë¦¬ë·° <span class="text-[#66c0f4]">{{ steam_reviews|length }}</span>
                    </h3>
                    <div class="space-y-4">
                        {% for review in steam_reviews %}
                        <div class="bg-slate-700/50 rounded-xl p-4 border border-slate-600">
                            <div class="flex items-start gap-3">
                                <div class="shrink-0">
                                    <div class="w-10 h-10 rounded-full flex items-center justify-center
                                        {% if review.is_recommended %}bg-green-500{% else %}bg-red-500{% endif %}">
                                        <i
                                            class="ph-fill {% if review.is_recommended %}ph-thumbs-up{% else %}ph-thumbs-down{% endif %} text-white text-lg"></i>
                                    </div>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center justify-between mb-2 flex-wrap gap-2">
                                        <div class="flex items-center gap-2">
                                            <span
                                                class="text-xs px-2 py-0.5 rounded-full
                                                {% if review.is_recommended %}bg-green-500/20 text-green-400{% else %}bg-red-500/20 text-red-400{% endif %}">
                                                {% if review.is_recommended %}ì¶”ì²œ{% else %}ë¹„ì¶”ì²œ{% endif %}
                                            </span>
                                            <span class="text-xs text-slate-400">
                                                {{ review.author_playtime_hours }}ì‹œê°„ í”Œë ˆì´
                                            </span>
                                        </div>
                                        <div class="flex items-center gap-2 text-xs text-slate-400">
                                            <span class="flex items-center gap-1">
                                                <i class="ph-fill ph-thumbs-up"></i>{{ review.votes_up }}
                                            </span>
                                        </div>
                                    </div>
                                    <p class="text-slate-200 text-sm leading-relaxed line-clamp-4">{{ review.content }}
                                    </p>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- User Ratings Section -->
                <div>
                    <h3 class="text-xl font-bold mb-6">ìœ ì € í‰ê°€ <span class="text-blue-600">{{ user_ratings.count }}</span>
                    </h3>
                    <div class="space-y-4">
                        {% for rating in user_ratings %}
                        <div class="flex gap-4 pb-4 border-b border-gray-100 last:border-0">
                            <div class="shrink-0">
                                <div
                                    class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-purple-500 flex items-center justify-center overflow-hidden">
                                    <i class="ph-fill ph-user text-white"></i>
                                </div>
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center justify-between mb-1">
                                    <span class="font-bold text-gray-900">
                                        {{ rating.user.nickname|default:rating.user.username }}</span>
                                    <span class="text-xs text-gray-400">{{ rating.updated_at|date:"Y.m.d" }}</span>
                                </div>
                                <div class="flex items-center gap-2 mb-1">
                                    {% if rating.score == -1 %}
                                    <span
                                        class="inline-flex items-center gap-1 px-2 py-1 bg-red-100 text-red-600 rounded-lg text-xs font-medium">
                                        <i class="ph-fill ph-thumbs-down"></i> ë³„ë¡œì˜ˆìš”
                                    </span>
                                    {% elif rating.score == 3.5 %}
                                    <span
                                        class="inline-flex items-center gap-1 px-2 py-1 bg-blue-100 text-blue-600 rounded-lg text-xs font-medium">
                                        <i class="ph-fill ph-thumbs-up"></i> ì¬ë°Œì–´ìš”
                                    </span>
                                    {% elif rating.score == 5 %}
                                    <span
                                        class="inline-flex items-center gap-1 px-2 py-1 bg-yellow-100 text-yellow-700 rounded-lg text-xs font-medium">
                                        <i class="ph-fill ph-thumbs-up"></i><i class="ph-fill ph-thumbs-up"></i> ì¸ìƒê²Œì„!
                                    </span>
                                    {% else %}
                                    <div class="flex items-center gap-1">
                                        {% for i in "12345" %}
                                        {% if forloop.counter <= rating.score %} <i
                                            class="ph-fill ph-star text-yellow-400 text-sm"></i>
                                            {% else %}
                                            <i class="ph-fill ph-star text-gray-200 text-sm"></i>
                                            {% endif %}
                                            {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                                {% if rating.comment %}
                                <p class="text-gray-600 text-sm leading-relaxed">{{ rating.comment }}</p>
                                {% endif %}
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center py-12 text-gray-400">
                            <i class="ph-duotone ph-heart text-4xl mb-3"></i>
                            <p>ì•„ì§ í‰ê°€ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ì²« ë²ˆì§¸ë¡œ ì´ ê²Œì„ì„ í‰ê°€í•´ë³´ì„¸ìš”!</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Right: Info Sidebar -->
            <div class="space-y-6">
                <div
                    class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-2xl p-6 border border-gray-200 sticky top-6">
                    <h3 class="font-bold text-gray-900 mb-4 flex items-center gap-2">
                        <i class="ph-fill ph-info text-blue-600"></i>
                        ê²Œì„ ì •ë³´
                    </h3>
                    <dl class="space-y-3 text-sm" id="gameInfoList">
                        <div class="flex justify-between items-start">
                            <dt class="text-gray-500 font-medium">ì¥ë¥´</dt>
                            <dd class="font-bold text-gray-900 text-right" id="sidebarGenre">{{ game.genre }}</dd>
                        </div>
                        {% if game.metacritic_score %}
                        <div class="flex justify-between items-start">
                            <dt class="text-gray-500 font-medium">ë©”íƒ€í¬ë¦¬í‹±</dt>
                            <dd class="font-bold text-green-600 text-right">{{ game.metacritic_score }}/100</dd>
                        </div>
                        {% endif %}
                        <!-- RAWG ë©”íƒ€í¬ë¦¬í‹± (JSë¡œ ì¶”ê°€) -->
                        <div id="sidebarMetacritic" class="hidden flex justify-between items-start">
                            <dt class="text-gray-500 font-medium">ë©”íƒ€í¬ë¦¬í‹±</dt>
                            <dd class="font-bold text-green-600 text-right"><span
                                    id="sidebarMetacriticValue"></span>/100</dd>
                        </div>
                        {% if game.rawg_id %}
                        <div class="flex justify-between items-start">
                            <dt class="text-gray-500 font-medium">RAWG ID</dt>
                            <dd class="font-medium text-gray-600 text-right">
                                <a href="https://rawg.io/games/{{ game.rawg_id }}" target="_blank"
                                    class="hover:text-blue-600 transition-colors">
                                    {{ game.rawg_id }} <i class="ph-bold ph-arrow-square-out text-xs"></i>
                                </a>
                            </dd>
                        </div>
                        {% endif %}
                        <div class="flex justify-between items-start">
                            <dt class="text-gray-500 font-medium">Steam AppID</dt>
                            <dd class="font-medium text-gray-600 text-right">{{ game.steam_appid }}</dd>
                        </div>
                        <!-- ê°œë°œì‚¬/í¼ë¸”ë¦¬ì…” (JSë¡œ ì¶”ê°€) -->
                        <div id="sidebarDeveloper" class="hidden flex justify-between items-start">
                            <dt class="text-gray-500 font-medium">ê°œë°œì‚¬</dt>
                            <dd class="font-medium text-gray-600 text-right" id="sidebarDeveloperValue"></dd>
                        </div>
                        <div id="sidebarPublisher" class="hidden flex justify-between items-start">
                            <dt class="text-gray-500 font-medium">í¼ë¸”ë¦¬ì…”</dt>
                            <dd class="font-medium text-gray-600 text-right" id="sidebarPublisherValue"></dd>
                        </div>
                        <!-- ì—­ëŒ€ ìµœì €ê°€ (JSë¡œ ì¶”ê°€) -->
                        <div id="sidebarLowestPrice" class="hidden flex justify-between items-start">
                            <dt class="text-gray-500 font-medium">ì—­ëŒ€ ìµœì €ê°€</dt>
                            <dd class="font-bold text-green-600 text-right" id="sidebarLowestPriceValue"></dd>
                        </div>
                    </dl>

                    <div id="screenshotStats"
                        class="{% if not screenshots %}hidden{% endif %} mt-6 pt-6 border-t border-gray-200">
                        <div class="grid grid-cols-2 gap-4 text-center">
                            <div>
                                <div class="text-2xl font-black text-blue-600" id="screenshotCount">
                                    {{ screenshots|length }}</div>
                                <div class="text-xs text-gray-500 font-medium">ìŠ¤í¬ë¦°ìƒ·</div>
                            </div>
                            {% if trailers.count > 0 %}
                            <div>
                                <div class="text-2xl font-black text-purple-600">{{ trailers.count }}</div>
                                <div class="text-xs text-gray-500 font-medium">ì˜ìƒ</div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>

<!-- Image Modal -->
<div id="imageModal" class="fixed inset-0 bg-black/90 z-50 hidden items-center justify-center p-4"
    onclick="handleModalClick(event)">
    
    <!-- Left Arrow -->
    <button id="modalPrevBtn" onclick="navigateScreenshot(-1); event.stopPropagation();"
        class="absolute left-4 top-1/2 -translate-y-1/2 w-14 h-14 bg-white/10 hover:bg-white/20 backdrop-blur-md text-white rounded-full flex items-center justify-center transition-all z-10 border border-white/20">
        <i class="ph-bold ph-caret-left text-2xl"></i>
    </button>
    
    <!-- Right Arrow -->
    <button id="modalNextBtn" onclick="navigateScreenshot(1); event.stopPropagation();"
        class="absolute right-4 top-1/2 -translate-y-1/2 w-14 h-14 bg-white/10 hover:bg-white/20 backdrop-blur-md text-white rounded-full flex items-center justify-center transition-all z-10 border border-white/20">
        <i class="ph-bold ph-caret-right text-2xl"></i>
    </button>
    
    <div class="relative max-w-6xl max-h-[90vh]" onclick="event.stopPropagation();">
        <button onclick="closeImageModal()"
            class="absolute -top-12 right-0 text-white hover:text-gray-300 transition-colors">
            <i class="ph-bold ph-x text-3xl"></i>
        </button>
        <img id="modalImage" src="" alt="Screenshot" class="max-w-full max-h-[85vh] rounded-lg shadow-2xl">
        
        <!-- Page Indicator -->
        <div id="modalIndicator" class="absolute -bottom-10 left-1/2 -translate-x-1/2 text-white text-sm font-medium bg-white/10 px-4 py-2 rounded-full backdrop-blur-md">
            <span id="modalCurrentIndex">1</span> / <span id="modalTotalCount">1</span>
        </div>
    </div>
</div>

<script>
    // RAWG APIë¡œ ì¶”ê°€ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    const RAWG_API_KEY = '{{ rawg_api_key }}';
    const GAME_TITLE = '{{ game.title|escapejs }}';
    const HAS_BACKGROUND = {% if game.background_image %}true{% else %} false{% endif %};
    const HAS_DESCRIPTION = {% if game.description %}true{% else %} false{% endif %};
    const HAS_SCREENSHOTS = {% if screenshots %}true{% else %} false{% endif %};
    const HAS_GENRE = {% if game.genre and game.genre != 'ê²Œì„' and game.genre != 'Unknown' %}true{% else %} false{% endif %};
    const HAS_METACRITIC = {% if game.metacritic_score %}true{% else %} false{% endif %};

    async function fetchRAWGData() {
        // ë°ì´í„°ê°€ ì´ë¯¸ ë‹¤ ìˆìœ¼ë©´ ìŠ¤í‚µ
        if (HAS_BACKGROUND && HAS_DESCRIPTION && HAS_SCREENSHOTS && HAS_GENRE && HAS_METACRITIC) {
            console.log('All data already available from DB');
            return;
        }

        try {
            // ê²Œì„ ì´ë¦„ìœ¼ë¡œ RAWG ê²€ìƒ‰
            const searchResponse = await fetch(`https://api.rawg.io/api/games?key=${RAWG_API_KEY}&search=${encodeURIComponent(GAME_TITLE)}&page_size=1`);
            const searchData = await searchResponse.json();

            if (!searchData.results || searchData.results.length === 0) {
                console.log('Game not found on RAWG');
                hideLoaders();
                return;
            }

            const gameId = searchData.results[0].id;

            // ê²Œì„ ìƒì„¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const detailResponse = await fetch(`https://api.rawg.io/api/games/${gameId}?key=${RAWG_API_KEY}`);
            const gameData = await detailResponse.json();

            // ë°°ê²½ ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸
            if (!HAS_BACKGROUND && gameData.background_image) {
                const headerImage = document.getElementById('headerImage');
                const headerPlaceholder = document.getElementById('headerPlaceholder');
                if (headerImage && headerPlaceholder) {
                    headerImage.src = gameData.background_image;
                    headerImage.classList.remove('hidden');
                    headerPlaceholder.classList.add('hidden');
                }
            }

            // ì¥ë¥´ ì—…ë°ì´íŠ¸
            if (!HAS_GENRE && gameData.genres && gameData.genres.length > 0) {
                const genreNames = gameData.genres.slice(0, 2).map(g => g.name).join(', ');
                document.getElementById('genreBadge').textContent = genreNames;
                document.getElementById('sidebarGenre').textContent = genreNames;
            }

            // ë©”íƒ€í¬ë¦¬í‹± ì—…ë°ì´íŠ¸
            if (!HAS_METACRITIC && gameData.metacritic) {
                document.getElementById('rawgMetacriticValue').textContent = gameData.metacritic;
                document.getElementById('rawgMetacriticBadge').classList.remove('hidden');
                document.getElementById('sidebarMetacriticValue').textContent = gameData.metacritic;
                document.getElementById('sidebarMetacritic').classList.remove('hidden');
            }

            // RAWG í‰ì  í‘œì‹œ
            if (gameData.rating) {
                document.getElementById('rawgRatingValue').textContent = gameData.rating.toFixed(1);
                document.getElementById('rawgRating').classList.remove('hidden');
                document.getElementById('rawgRating').classList.add('flex');
            }

            // ì¶œì‹œì¼ í‘œì‹œ
            if (gameData.released) {
                document.getElementById('releasedValue').textContent = gameData.released;
                document.getElementById('releasedDate').classList.remove('hidden');
                document.getElementById('releasedDate').classList.add('flex');
            }

            // ê°œë°œì‚¬/í¼ë¸”ë¦¬ì…” í‘œì‹œ
            if (gameData.developers && gameData.developers.length > 0) {
                document.getElementById('sidebarDeveloperValue').textContent = gameData.developers.map(d => d.name).join(', ');
                document.getElementById('sidebarDeveloper').classList.remove('hidden');
                document.getElementById('sidebarDeveloper').classList.add('flex');
            }
            if (gameData.publishers && gameData.publishers.length > 0) {
                document.getElementById('sidebarPublisherValue').textContent = gameData.publishers.map(p => p.name).join(', ');
                document.getElementById('sidebarPublisher').classList.remove('hidden');
                document.getElementById('sidebarPublisher').classList.add('flex');
            }

            // ì„¤ëª… ì—…ë°ì´íŠ¸
            if (!HAS_DESCRIPTION && gameData.description_raw) {
                const descLoader = document.getElementById('descriptionLoader');
                if (descLoader) descLoader.classList.add('hidden');
                const originalDesc = document.getElementById('originalDescription');
                if (originalDesc) {
                    originalDesc.innerHTML = gameData.description_raw.split('\n\n').map(p => `<p class="mb-4">${p}</p>`).join('');
                }
            }

            // ìŠ¤í¬ë¦°ìƒ· ê°€ì ¸ì˜¤ê¸°
            if (!HAS_SCREENSHOTS) {
                const screenshotsResponse = await fetch(`https://api.rawg.io/api/games/${gameId}/screenshots?key=${RAWG_API_KEY}&page_size=8`);
                const screenshotsData = await screenshotsResponse.json();

                const screenshotsLoader = document.getElementById('screenshotsLoader');
                if (screenshotsLoader) screenshotsLoader.classList.add('hidden');

                if (screenshotsData.results && screenshotsData.results.length > 0) {
                    const grid = document.getElementById('screenshotsGrid');
                    grid.innerHTML = screenshotsData.results.map(ss => `
                        <div class="group relative aspect-video rounded-xl overflow-hidden bg-gray-100 cursor-pointer hover:ring-4 hover:ring-blue-500 transition-all"
                            onclick="openImageModal('${ss.image}')">
                            <img src="${ss.image}" alt="ìŠ¤í¬ë¦°ìƒ·"
                                class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300">
                            <div class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-colors pointer-events-none"></div>
                        </div>
                    `).join('');

                    // ìŠ¤í¬ë¦°ìƒ· URL ë°°ì—´ ì—…ë°ì´íŠ¸ (ëª¨ë‹¬ ë„¤ë¹„ê²Œì´ì…˜ìš©)
                    screenshotUrls = screenshotsData.results.map(ss => ss.image);

                    // ìŠ¤í¬ë¦°ìƒ· í†µê³„ ì—…ë°ì´íŠ¸
                    document.getElementById('screenshotCount').textContent = screenshotsData.results.length;
                    document.getElementById('screenshotStats').classList.remove('hidden');
                } else {
                    document.getElementById('screenshotsSection').classList.add('hidden');
                }
            }

        } catch (error) {
            console.error('Failed to fetch RAWG data:', error);
            hideLoaders();
        }
    }

    function hideLoaders() {
        // Updated loader handling handled inline/by innerHTML replacement
    }

    // ========== ìŠ¤í¬ë¦°ìƒ· ëª¨ë‹¬ ë„¤ë¹„ê²Œì´ì…˜ ==========
    let screenshotUrls = [];
    let currentScreenshotIndex = 0;

    // ìŠ¤í¬ë¦°ìƒ· URL ë°°ì—´ ì´ˆê¸°í™” (Django í…œí”Œë¦¿ì—ì„œ)
    {% if screenshots %}
    screenshotUrls = [
        {% for screenshot in screenshots %}
        '{{ screenshot.image_url }}'{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    {% endif %}

    function openImageModal(imageUrl) {
        const modal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');
        
        // í˜„ì¬ ì¸ë±ìŠ¤ ì°¾ê¸°
        currentScreenshotIndex = screenshotUrls.indexOf(imageUrl);
        if (currentScreenshotIndex === -1) currentScreenshotIndex = 0;
        
        modalImage.src = imageUrl;
        updateModalIndicator();
        
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    function closeImageModal() {
        const modal = document.getElementById('imageModal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }

    function handleModalClick(event) {
        // ë°°ê²½ í´ë¦­ ì‹œì—ë§Œ ë‹«ê¸°
        if (event.target.id === 'imageModal') {
            closeImageModal();
        }
    }

    function navigateScreenshot(direction) {
        if (screenshotUrls.length === 0) return;
        
        currentScreenshotIndex += direction;
        
        // ìˆœí™˜ ì²˜ë¦¬
        if (currentScreenshotIndex < 0) {
            currentScreenshotIndex = screenshotUrls.length - 1;
        } else if (currentScreenshotIndex >= screenshotUrls.length) {
            currentScreenshotIndex = 0;
        }
        
        const modalImage = document.getElementById('modalImage');
        modalImage.src = screenshotUrls[currentScreenshotIndex];
        updateModalIndicator();
    }

    function updateModalIndicator() {
        document.getElementById('modalCurrentIndex').textContent = currentScreenshotIndex + 1;
        document.getElementById('modalTotalCount').textContent = screenshotUrls.length;
        
        // ìŠ¤í¬ë¦°ìƒ·ì´ 1ê°œë©´ í™”ì‚´í‘œ ìˆ¨ê¹€
        const prevBtn = document.getElementById('modalPrevBtn');
        const nextBtn = document.getElementById('modalNextBtn');
        const indicator = document.getElementById('modalIndicator');
        
        if (screenshotUrls.length <= 1) {
            prevBtn.classList.add('hidden');
            nextBtn.classList.add('hidden');
            indicator.classList.add('hidden');
        } else {
            prevBtn.classList.remove('hidden');
            nextBtn.classList.remove('hidden');
            indicator.classList.remove('hidden');
        }
    }

    // RAWGì—ì„œ ìŠ¤í¬ë¦°ìƒ· ë¡œë“œ ì‹œ ë°°ì—´ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateScreenshotUrls(urls) {
        screenshotUrls = urls;
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ RAWG ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    document.addEventListener('DOMContentLoaded', fetchRAWGData);

    // í‚¤ë³´ë“œ ì´ë²¤íŠ¸: ESCë¡œ ë‹«ê¸°, ì¢Œìš° í™”ì‚´í‘œë¡œ ë„¤ë¹„ê²Œì´ì…˜
    document.addEventListener('keydown', function (e) {
        const modal = document.getElementById('imageModal');
        if (modal.classList.contains('hidden')) return;
        
        if (e.key === 'Escape') {
            closeImageModal();
        } else if (e.key === 'ArrowLeft') {
            navigateScreenshot(-1);
        } else if (e.key === 'ArrowRight') {
            navigateScreenshot(1);
        }
    });

    // ========== ë„·í”Œë¦­ìŠ¤ ìŠ¤íƒ€ì¼ í‰ê°€ ê¸°ëŠ¥ ==========
    let currentUserRating = null;
    const GAME_RAWG_ID = '{{ game.rawg_id|default:""|escapejs }}';
    const GAME_IMAGE = '{{ game.background_image|default:game.image_url|default:""|escapejs }}';
    const STEAM_APPID = '{{ game.steam_appid|default:""|escapejs }}';

    // CSRF í† í° ê°€ì ¸ì˜¤ê¸°
    function getCsrfToken() {
        const name = 'csrftoken';
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            const [key, value] = cookie.trim().split('=');
            if (key === name) return value;
        }
        return '';
    }

    // í‰ê°€ ë²„íŠ¼ UI ì—…ë°ì´íŠ¸
    function updateRatingUI(score) {
        const buttons = document.querySelectorAll('.rating-btn');
        buttons.forEach(btn => {
            btn.classList.remove('bg-red-500', 'bg-blue-500', 'bg-yellow-500', 'scale-110');
            btn.classList.add('bg-white/20');
        });

        const label = document.getElementById('ratingLabel');

        if (score !== null) {
            let btnId, labelText, colorClass;
            if (score === -1) {
                btnId = 'rateBtn-1';
                labelText = 'ğŸ˜ ë³„ë¡œì˜ˆìš”';
                colorClass = 'bg-red-500';
            } else if (score === 3.5) {
                btnId = 'rateBtn3.5';
                labelText = 'ğŸ‘ ì¬ë°Œì–´ìš”';
                colorClass = 'bg-blue-500';
            } else if (score === 5) {
                btnId = 'rateBtn5';
                labelText = 'ğŸ”¥ ì¸ìƒê²Œì„!';
                colorClass = 'bg-yellow-500';
            }

            const btn = document.getElementById(btnId);
            if (btn) {
                btn.classList.remove('bg-white/20');
                btn.classList.add(colorClass, 'scale-110');
            }
            label.textContent = labelText;
            label.classList.remove('hidden');
        } else {
            label.classList.add('hidden');
        }
    }

    // í‰ê°€ ì €ì¥ API í˜¸ì¶œ
    async function rateGame(score) {
        // ê°™ì€ ì ìˆ˜ í´ë¦­ ì‹œ í† ê¸€ (ì·¨ì†Œ)
        if (currentUserRating === score) {
            currentUserRating = null;
            updateRatingUI(null);
            return;
        }

        currentUserRating = score;
        updateRatingUI(score);

        // RAWG IDê°€ ì—†ìœ¼ë©´ ì €ì¥í•˜ì§€ ì•ŠìŒ
        if (!GAME_RAWG_ID) {
            console.log('No RAWG ID available, rating not saved to server');
            return;
        }

        try {
            const response = await fetch('/users/api/onboarding/rate/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({
                    game_id: parseInt(GAME_RAWG_ID),
                    game_title: GAME_TITLE,
                    game_image: GAME_IMAGE,
                    score: score
                })
            });

            if (response.ok) {
                console.log('Rating saved:', score);
            } else {
                console.error('Failed to save rating');
            }
        } catch (e) {
            console.error('Error saving rating:', e);
        }
    }

    // ê¸°ì¡´ í‰ê°€ ë¶ˆëŸ¬ì˜¤ê¸°
    async function fetchUserRating() {
        if (!GAME_RAWG_ID) return;

        try {
            const response = await fetch(`/users/api/game-rating/${GAME_RAWG_ID}/`);
            if (response.ok) {
                const data = await response.json();
                if (data.score !== undefined && data.score !== null) {
                    currentUserRating = data.score;
                    updateRatingUI(data.score);
                }
            }
        } catch (e) {
            // ë¡œê·¸ì¸í•˜ì§€ ì•Šì•˜ê±°ë‚˜ í‰ê°€ê°€ ì—†ëŠ” ê²½ìš° ë¬´ì‹œ
        }
    }

    // ========== ì°œ(ìœ„ì‹œë¦¬ìŠ¤íŠ¸) ê¸°ëŠ¥ ==========
    let isWishlisted = false;

    // ì°œ ìƒíƒœ UI ì—…ë°ì´íŠ¸
    function updateWishlistUI(wishlisted) {
        const btn = document.getElementById('wishlistBtn');
        const icon = document.getElementById('wishlistIcon');
        
        if (!btn || !icon) return;
        
        if (wishlisted) {
            btn.classList.remove('bg-white/20');
            btn.classList.add('bg-pink-500');
            icon.classList.add('text-white');
            icon.classList.remove('text-white/70');
            btn.title = 'ì°œ í•´ì œ';
        } else {
            btn.classList.add('bg-white/20');
            btn.classList.remove('bg-pink-500');
            icon.classList.remove('text-white');
            icon.classList.add('text-white/70');
            btn.title = 'ì°œí•˜ê¸°';
        }
    }

    // ì°œ í† ê¸€
    async function toggleWishlistDetail() {
        if (!GAME_RAWG_ID) {
            console.log('No RAWG ID available');
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            return;
        }

        try {
            const response = await fetch(`/games/api/wishlist/${GAME_RAWG_ID}/toggle/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({
                    title: GAME_TITLE,
                    image_url: GAME_IMAGE
                })
            });

            if (response.ok) {
                const data = await response.json();
                isWishlisted = data.is_wishlisted;
                updateWishlistUI(isWishlisted);
                console.log('Wishlist toggled:', isWishlisted);
            } else if (response.status === 401 || response.status === 403) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            } else {
                console.error('Failed to toggle wishlist');
            }
        } catch (e) {
            console.error('Wishlist toggle error:', e);
        }
    }

    // ì°œ ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸°
    async function fetchWishlistStatus() {
        if (!GAME_RAWG_ID) return;

        try {
            const response = await fetch(`/games/api/wishlist/${GAME_RAWG_ID}/status/`);
            if (response.ok) {
                const data = await response.json();
                isWishlisted = data.is_wishlisted;
                updateWishlistUI(isWishlisted);
            }
        } catch (e) {
            // ë¡œê·¸ì¸í•˜ì§€ ì•Šì•˜ê±°ë‚˜ ì˜¤ë¥˜ê°€ ìˆëŠ” ê²½ìš° ë¬´ì‹œ
        }
    }

    // ========== ë²ˆì—­ ê¸°ëŠ¥ ==========
    let isTranslating = false;
    const translationBtn = document.getElementById('translationBtn');
    const translationIcon = document.getElementById('translationIcon');
    const translationText = document.getElementById('translationText');
    const translatedContent = document.getElementById('translatedContent');
    const translatedTextEl = document.getElementById('translatedText');
    const originalDescription = document.getElementById('originalDescription');
    const translationError = document.getElementById('translationError');
    const translationErrorText = document.getElementById('translationErrorText');
    const GAME_DESCRIPTION = `{{ game.description|escapejs }}`;
    const GAME_PK = '{{ game.pk }}';

    async function toggleTranslation() {
        // 1. í˜„ì¬ ë²ˆì—­ë³¸ì„ ë³´ê³  ìˆë‹¤ë©´ -> ì›ë¬¸ìœ¼ë¡œ ì „í™˜
        if (!translatedContent.classList.contains('hidden')) {
            translatedContent.classList.add('hidden');
            originalDescription.classList.remove('hidden');

            // ë²„íŠ¼ ìŠ¤íƒ€ì¼: ê¸°ë³¸ ìƒíƒœë¡œ
            translationBtn.classList.remove('bg-blue-100', 'text-blue-700', 'hover:bg-blue-200');
            translationBtn.classList.add('bg-transparent', 'text-gray-500', 'hover:bg-gray-100', 'border-gray-200');
            translationIcon.className = 'ph-bold ph-translate';
            translationText.textContent = 'í•œêµ­ì–´ë¡œ ë²ˆì—­';
            return;
        }

        // 2. í˜„ì¬ ì›ë¬¸ì„ ë³´ê³  ìˆê³ , ë²ˆì—­ë³¸ ë°ì´í„°ê°€ ìˆë‹¤ë©´ -> ë²ˆì—­ë³¸ìœ¼ë¡œ ì „í™˜
        if (translatedTextEl.innerText.trim().length > 0) {
            originalDescription.classList.add('hidden');
            translatedContent.classList.remove('hidden');

            // ë²„íŠ¼ ìŠ¤íƒ€ì¼: í™œì„± ìƒíƒœë¡œ
            translationBtn.classList.remove('bg-transparent', 'text-gray-500', 'hover:bg-gray-100', 'border-gray-200');
            translationBtn.classList.add('bg-blue-100', 'text-blue-700', 'hover:bg-blue-200');
            translationIcon.className = 'ph-fill ph-globe';
            translationText.textContent = 'ì›ë¬¸ ë³´ê¸°';
            return;
        }

        // 3. ë²ˆì—­ ë°ì´í„°ê°€ ì—†ë‹¤ë©´ -> API ìš”ì²­
        let textToTranslate = GAME_DESCRIPTION;
        if (!textToTranslate) {
            textToTranslate = originalDescription.innerText.trim();
        }

        if (!textToTranslate) return;

        isTranslating = true;
        translationBtn.disabled = true;
        const originalIconClass = translationIcon.className;
        translationIcon.className = 'ph-bold ph-spinner animate-spin';
        translationText.textContent = 'ë²ˆì—­ ì¤‘...';
        translationError.classList.add('hidden');

        try {
            const response = await fetch('/games/api/translate/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({
                    game_pk: GAME_PK,
                    rawg_id: GAME_RAWG_ID,
                    text: textToTranslate
                })
            });

            const data = await response.json();

            if (data.success && data.translated) {
                translatedTextEl.innerHTML = formatDescription(data.translated);

                // í™”ë©´ ì „í™˜
                originalDescription.classList.add('hidden');
                translatedContent.classList.remove('hidden');

                // ë²„íŠ¼ ì—…ë°ì´íŠ¸
                translationBtn.classList.remove('bg-transparent', 'text-gray-500', 'hover:bg-gray-100', 'border-gray-200');
                translationBtn.classList.add('bg-blue-100', 'text-blue-700', 'hover:bg-blue-200');
                translationIcon.className = 'ph-fill ph-globe';
                translationText.textContent = 'ì›ë¬¸ ë³´ê¸°';
            } else {
                throw new Error(data.error || 'ë²ˆì—­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (e) {
            console.error('Translation error:', e);
            translationErrorText.textContent = e.message || 'ë²ˆì—­ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            translationError.classList.remove('hidden');

            // ë²„íŠ¼ ë³µêµ¬
            translationIcon.className = originalIconClass;
            translationText.textContent = 'í•œêµ­ì–´ë¡œ ë²ˆì—­';
        } finally {
            isTranslating = false;
            translationBtn.disabled = false;
        }
    }

    function formatDescription(text) {
        if (!text) return '';
        return text.split('\n\n').map(p => `<p class="mb-4">${p}</p>`).join('');
    }

    // ========== CheapShark ê°€ê²© ë¹„êµ ê¸°ëŠ¥ ==========
    async function fetchCheapSharkDeal() {
        if (!STEAM_APPID) {
            // Steam AppIDê°€ ì—†ìœ¼ë©´ ë²„íŠ¼ ìˆ¨ê¹€
            const btn = document.getElementById('cheapsharkBtn');
            if (btn) btn.style.display = 'none';
            return;
        }

        const btn = document.getElementById('cheapsharkBtn');
        const icon = document.getElementById('cheapsharkIcon');
        const text = document.getElementById('cheapsharkText');
        
        if (!btn || !icon || !text) return;

        try {
            // ë°±ì—”ë“œ APIì—ì„œ ë°ì´í„°ì…‹ì˜ CheapShark URL ê°€ì ¸ì˜¤ê¸° (ë” ì•ˆì •ì )
            const response = await fetch(`/users/api/cheapshark/${STEAM_APPID}/`);
            if (!response.ok) throw new Error('API error');
            
            const data = await response.json();
            
            if (data.found && data.cheapshark_url) {
                // ë°ì´í„°ì…‹ì—ì„œ ì°¾ì€ ê²½ìš° - ì €ì¥ëœ redirect URL ì‚¬ìš©
                const currentPrice = data.current_price;
                const discountPercent = data.discount_percent;
                
                btn.href = data.cheapshark_url;
                btn.target = '_blank';
                btn.onclick = null;
                btn.classList.remove('opacity-50', 'cursor-wait');
                btn.title = currentPrice ? `â‚©${currentPrice}` : 'ê°€ê²© ë¹„êµ';
                
                icon.classList.remove('ph-spinner', 'animate-spin');
                icon.classList.add('ph-lightning');
                
                if (currentPrice && discountPercent > 0) {
                    text.innerHTML = `â‚©${currentPrice} <span class="text-yellow-300">(-${discountPercent}%)</span>`;
                } else if (currentPrice) {
                    text.textContent = `â‚©${currentPrice}`;
                } else {
                    text.textContent = 'ë°”ë¡œ êµ¬ë§¤';
                }
                
                // ì‚¬ì´ë“œë°”ì— ì—­ëŒ€ ìµœì €ê°€ í‘œì‹œ
                if (data.cheapest_price_ever_krw) {
                    const lowestPriceEl = document.getElementById('sidebarLowestPrice');
                    const lowestPriceValue = document.getElementById('sidebarLowestPriceValue');
                    if (lowestPriceEl && lowestPriceValue) {
                        lowestPriceValue.textContent = `â‚©${data.cheapest_price_ever_krw.toLocaleString()}`;
                        lowestPriceEl.classList.remove('hidden');
                        lowestPriceEl.classList.add('flex');
                        
                        // ì—­ëŒ€ ìµœì €ê°€ì¸ ê²½ìš° ê°•ì¡°
                        if (data.is_historical_low) {
                            lowestPriceValue.innerHTML = `â‚©${data.cheapest_price_ever_krw.toLocaleString()} <span class="text-xs text-red-500 animate-pulse">ğŸ”¥ì§€ê¸ˆ!</span>`;
                        }
                    }
                }
            } else {
                // ë°ì´í„°ì…‹ì— ì—†ëŠ” ê²½ìš° - Steam ë§í¬ë¡œ í´ë°±
                btn.href = `https://store.steampowered.com/app/${STEAM_APPID}`;
                btn.target = '_blank';
                btn.onclick = null;
                btn.classList.remove('opacity-50', 'cursor-wait');
                btn.title = 'Steamì—ì„œ í™•ì¸';
                
                icon.classList.remove('ph-spinner', 'animate-spin');
                icon.classList.add('ph-storefront');
                text.textContent = 'Steam í™•ì¸';
            }
        } catch (e) {
            console.error('CheapShark API error:', e);
            // ì—ëŸ¬ ì‹œ Steam ë§í¬ë¡œ í´ë°±
            btn.href = `https://store.steampowered.com/app/${STEAM_APPID}`;
            btn.target = '_blank';
            btn.onclick = null;
            btn.classList.remove('opacity-50', 'cursor-wait');
            
            icon.classList.remove('ph-spinner', 'animate-spin');
            icon.classList.add('ph-storefront');
            text.textContent = 'Steam í™•ì¸';
        }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ì¡´ í‰ê°€ ë° ì°œ ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸°
    document.addEventListener('DOMContentLoaded', () => {
        fetchUserRating();
        fetchWishlistStatus();
        fetchCheapSharkDeal();
    });

    // ========== ë³„ì  ë¦¬ë·° ì‹œê° íš¨ê³¼ ==========
    const starContainer = document.getElementById('starRatingContainer');
    const starInputs = document.querySelectorAll('input[name="score"]');
    const starIcons = document.querySelectorAll('.review-star-icon');

    function fillStars(value) {
        starIcons.forEach((icon, index) => {
            if (index < value) {
                icon.classList.remove('text-gray-300');
                icon.classList.add('text-yellow-400');
            } else {
                icon.classList.remove('text-yellow-400');
                icon.classList.add('text-gray-300');
            }
        });
    }

    if (starContainer) {
        // Hover effects
        starInputs.forEach(input => {
            const label = input.closest('label');
            label.addEventListener('mouseenter', () => {
                fillStars(input.value);
            });
        });

        // Reset on leave
        starContainer.addEventListener('mouseleave', () => {
            const checked = document.querySelector('input[name="score"]:checked');
            fillStars(checked ? checked.value : 0);
        });

        // Initialize state
        const checked = document.querySelector('input[name="score"]:checked');
        fillStars(checked ? checked.value : 0);
    }
</script>
{% endblock %}